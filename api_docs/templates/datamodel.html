{% extends "base/inside_page.html" %}
{% load markdown_content %}
{% block breadcrumb %}
<div class="right-content__breadcrumb">
  <div class="col-xs-11 no-pad-r">
    <ol class="breadcrumb">
      <li><a href="/api/analysis/">Analysis</a></li>
    </ol>
  </div>
</div>
{% endblock %}

{% block right_content %}
<h1>URLs Datamodel</h1>
<div id="datamodel">
  <form class="form-inline">
    <div class="form-group">
      <label>Comparison: </label>
      <select name="selectCompGroup" class="form-control input-sm">
        <option value="current" selected>Current</option>
        <option value="previous">Previous</option>
        <option value="diff">Diff</option>
      </select>
    </div>
    <div class="form-group">
      <label>Group: </label>
      <select name="selectGroup" class="form-control input-sm">
        <option value="all" selected>all</option>
      </select>
    </div>
  </form>
  <table class="table datamodel-table">
    <thead>
      <tr>
        <th>Group</th>
        <th>Field Id</th>
        <th>Name</th>
        <th>Permissions</th>
        <th>Type</th>
        <th>SubType</th>
        <th>Multiple</th>
      </tr>
    </thead>
  </table>
</div>
{% md_content "partials/urls-datamodel.md" %}
{% endblock %}

{% block extra_script %}
<script type="text/javascript">
  $(function () {
    var initialFilter = url('?') && url('?').filter;

    var compGroupFilter = $('select[name=selectCompGroup]');
    var groupFilter = $('select[name=selectGroup]');

    var groups = {
      current: [],
      previous: [],
      diff: [],
    };

    $.fn.dataTable.ext.search.push(
      function( settings, data, dataIndex ) {
        var compGroup = compGroupFilter.val();
        var group = groupFilter.val();
        var rowGroup = data[0];

        return group !== 'all' && rowGroup === group ? true
             : group === 'all' && groups[compGroup].indexOf(rowGroup) !== -1 ? true
             : false;
      }
    );

    var datamodel = $('#datamodel table').DataTable({
      processing: true,
      ajax: {
        url: "{{ datamodel_api_url }}",
        dataType: "json",
        dataSrc: function(json) {
          // Populate groups
          json.groups.forEach(function(group) {
            var compGroup = getCompGroup(group.id);
            if (groups[compGroup].indexOf(group.id) === -1) {
              groups[compGroup].push(group.id);
            }
          });
          updateGroupFilter();

          return json.fields;
        },
      },
      columns: [
        { data: "group" },
        { data: "id" },
        { data: "name" },
        {
          data: "permissions",
          render: "[, ]"
        },
        { data: "type" },
        { data: "subtype" },
        { data: "multiple" },
      ],
      scrollX: true,
      search: {
        regex: true,
        search: initialFilter || undefined,
      },
      pagingType: "numbers",
    });

    compGroupFilter.change( function() {
      updateGroupFilter();
      datamodel.draw();
    });

    groupFilter.change( function() {
      datamodel.draw();
    });

    function getCompGroup(group) {
      return group.indexOf('previous.') === 0 ? 'previous'
          : group.indexOf('diff.') === 0 ? 'diff'
          : 'current';
    }

    function updateGroupFilter() {
      var compGroup = compGroupFilter.val();
      groupFilter.empty();
      groupFilter.append($('<option>', {
        value: 'all',
        text: 'all'
      }));
      groups[compGroup].forEach(function(group) {
        groupFilter.append($('<option>', {
          value: group,
          text: group
        }));
      });
      groupFilter.val('all');
    }
  });

</script>

<script>hljs.initHighlightingOnLoad();</script>
<script>
  $(document).ready(function() {
    $(".dropdown-toggle").dropdown();
  });
</script>
{% endblock %}
